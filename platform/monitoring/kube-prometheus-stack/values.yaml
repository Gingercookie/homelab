kube-prometheus-stack:
  # Prometheus configuration
  prometheus:
    prometheusSpec:
      # Resource limits for Pi
      resources:
        requests:
          cpu: 200m
          memory: 1Gi
        limits:
          memory: 1Gi

      # Storage - using local-path
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi

      # Retention settings
      retention: 7d
      retentionSize: "9GB"

      # Scraping intervals - less frequent to save resources
      scrapeInterval: 60s
      evaluationInterval: 60s

      # Enable service monitors
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false

  # Grafana configuration
  grafana:
    enabled: true
    adminPassword: "admin"  # Change this or use external secret

    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        memory: 1Gi

    persistence:
      enabled: true
      storageClassName: local-path
      size: 5Gi

    # Access via port-forward for now
    # kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80
    service:
      type: ClusterIP

    # Pre-configure Loki datasource
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki-gateway.logging.svc.cluster.local:80
        access: proxy
        isDefault: false
        jsonData:
          maxLines: 1000

    # Enable useful dashboards
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default

    dashboards:
      default:
        kubernetes-cluster:
          gnetId: 7249
          revision: 1
          datasource: Prometheus
        node-exporter:
          gnetId: 1860
          revision: 31
          datasource: Prometheus

  # Alertmanager configuration
  alertmanager:
    alertmanagerSpec:
      resources:
        requests:
          cpu: 10m
          memory: 128Mi
        limits:
          memory: 128Mi

      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

      retention: 120h
      replicas: 1
      logFormat: json

  # Prometheus Operator
  prometheusOperator:
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 50m
        memory: 128Mi

    admissionWebhooks:
      enabled: true
      patch:
        enabled: true
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 10m
            memory: 32Mi

    prometheusConfigReloader:
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          cpu: 10m
          memory: 32Mi

  # Node Exporter - essential for node metrics
  nodeExporter:
    enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 64Mi

  # Kube State Metrics
  kubeStateMetrics:
    enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 128Mi

  # Disable some heavy components we don't need right now
  coreDns:
    enabled: false
  kubeDns:
    enabled: false
  kubeEtcd:
    enabled: false
  kubeControllerManager:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeProxy:
    enabled: false
