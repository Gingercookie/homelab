kube-prometheus-stack:

  prometheus:
    prometheusSpec:
      # Resources
      resources:
        requests:
          cpu: 250m
          memory: 2Gi
        limits:
          memory: 2Gi

      # Storage
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 20Gi

      # Retention
      retention: 14d
      retentionSize: "18GB"

      # Scraping intervals
      scrapeInterval: 60s
      scrapeTimeout: 50s
      evaluationInterval: 60s

      # WAL compression
      walCompression: true

      # Selectors
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false

      # ============================================
      # OPENTELEMETRY OTLP RECEIVER
      # ============================================
      enableFeatures:
        - otlp-write-receiver
        - exemplar-storage          # Link metrics to traces

      # Enable remote write receiver for OTLP
      enableRemoteWriteReceiver: true

      # Exemplar storage for trace correlation
      exemplars:
        maxSize: 100000

      # Additional ports for OTLP
      additionalServicePorts:
        - name: otlp-grpc
          port: 4317
          targetPort: 4317
          protocol: TCP
        - name: otlp-http
          port: 4318
          targetPort: 4318
          protocol: TCP

  # Grafana with Tempo datasource
  grafana:
    enabled: true

    resources:
      requests:
        cpu: 100m
        memory: 1Gi
      limits:
        memory: 1Gi

    persistence:
      enabled: true
      storageClassName: local-path
      size: 5Gi

    adminPassword: "admin"

    grafana.ini:
      server:
        root_url: "http://localhost:3000"
      analytics:
        reporting_enabled: false
        check_for_updates: false
      log:
        mode: console
        level: info
      database:
        type: sqlite3
      dashboards:
        min_refresh_interval: 30s

      # ============================================
      # TRACING CONFIGURATION
      # ============================================
      feature_toggles:
        enable: traceqlEditor tempoSearch tempoBackendSearch

    # Data sources - Prometheus, Loki, AND Tempo
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki-gateway.logging.svc.cluster.local:80
        access: proxy
        isDefault: false
        jsonData:
          maxLines: 1000
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: "traceID=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"

      - name: Tempo
        type: tempo
        url: http://tempo.observability.svc.cluster.local:3100
        access: proxy
        isDefault: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            filterByTraceID: true
            filterBySpanID: false
          tracesToMetrics:
            datasourceUid: prometheus
          serviceMap:
            datasourceUid: prometheus
          nodeGraph:
            enabled: true
          lokiSearch:
            datasourceUid: loki

    # Dashboards
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default

    dashboards:
      default:
        kubernetes-cluster:
          gnetId: 7249
          revision: 1
          datasource: Prometheus
        node-exporter:
          gnetId: 1860
          revision: 31
          datasource: Prometheus
        kubernetes-pods:
          gnetId: 6417
          revision: 1
          datasource: Prometheus
        # OpenTelemetry dashboards
        otel-collector:
          gnetId: 15983
          revision: 1
          datasource: Prometheus

    sidecar:
      resources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          memory: 256Mi
      dashboards:
        enabled: true
        label: grafana_dashboard
      datasources:
        enabled: true
        label: grafana_datasource

  # Alertmanager
  alertmanager:
    enabled: true
    alertmanagerSpec:
      resources:
        requests:
          cpu: 10m
          memory: 128Mi
        limits:
          memory: 128Mi
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi
      retention: 120h
      replicas: 1
      logLevel: info
      logFormat: json

  # Prometheus Operator
  prometheusOperator:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 256Mi
    admissionWebhooks:
      enabled: true
      patch:
        enabled: true
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 32Mi
    prometheusConfigReloader:
      resources:
        requests:
          cpu: 10m
          memory: 64Mi
        limits:
          memory: 64Mi

  # Kube State Metrics
  kube-state-metrics:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 128Mi

  # Node Exporter
  prometheus-node-exporter:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 64Mi

  # Default rules
  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8sContainerCpuUsageSecondsTotal: true
      k8sContainerMemoryCache: true
      k8sContainerMemoryRss: true
      k8sContainerMemorySwap: true
      k8sContainerResource: true
      k8sContainerMemoryWorkingSetBytes: true
      k8sPodOwner: true
      kubeApiserver: false
      kubeApiserverAvailability: true
      kubeApiserverBurnrate: false
      kubeApiserverHistogram: false
      kubeApiserverSlos: false
      kubeControllerManager: false
      kubelet: true
      kubeProxy: false
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeSchedulerAlerting: false
      kubeSchedulerRecording: false
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true

  # Component monitoring
  kubeApiServer:
    enabled: false
  kubeControllerManager:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeProxy:
    enabled: false
  kubeEtcd:
    enabled: false
  coreDns:
    enabled: true
  kubeDns:
    enabled: false
